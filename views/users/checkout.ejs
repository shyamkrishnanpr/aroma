<%-include('../layouts/header') %>

<!--================Checkout Area =================-->
<section class="checkout_area section-margin--small">
  <div class="container">
    
    <div class="billing_details">
      <div class="row">
        <div class="col-lg-8">
          <h3>Billing Details</h3>
          <label for="country">Select Shipping Address</label>
          <div class="default-select">
            <select
              required
              aria-placeholder="select your address"
              class="form-control form-select mt-2"
              style="color: #000"
              onchange="updateAddressDetail(this.value)"
            >
              <% if (userData.addressDetail && userData.addressDetail.length> 0)
              { %> <% for (let i=0; i < userData.addressDetail.length; i++) { %>
              <option value="<%=userData.addressDetail[i]._id%>">               
                <%=userData.addressDetail[i].housename%>,
                <%=userData.addressDetail[i].postoffice%>,
                <%=userData.addressDetail[i].area%>,
                <%=userData.addressDetail[i].district%>,
                <%=userData.addressDetail[i].state%>,
                <%=userData.addressDetail[i].pin%>,
              </option>
              <% } %> <% } else { %>
              <p>No address selected</p>
              <% } %>
            </select>
          </div>
          <hr>
          <form
            class="row contact_form"
            action="/placeOrder/"
            method="post"
            id="placeOrder"
          >
          <div class="col-md-6">
                      <div class="form-group">
                        <label for="phonenumber">Phone number</label>
                        <input type="text" required name="phonenumber" id="phonenumber" style="
                   
                            color: rgb(92, 92, 92) !important;
                          " class="form-control" placeholder=""  />
                      </div>
                    </div>

                    
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="housename">House Name</label>
                        <input type="text" required name="housename" id="housename" style="
                         
                            color: rgb(92, 92, 92) !important;
                          " class="form-control" placeholder="" fdprocessedid="ib393" />
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="postoffice">Post Office</label>
                        <input type="text" required id="postoffice" name="postoffice" style="
                        
                            color: rgb(92, 92, 92) !important;
                          " class="form-control" placeholder="" fdprocessedid="4xtq1b" />
                      </div>
                    </div>

                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="area">Area</label>
                        <input type="text" required id="area" name="area" style="
                           
                            color: rgb(92, 92, 92) !important;
                          " class="form-control" placeholder="" fdprocessedid="4xtq1b" />
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="district">District</label>
                        <input type="text" required id="district" name="district" style="
                 
                            color: rgb(92, 92, 92) !important;
                          " class="form-control" placeholder="" fdprocessedid="4xtq1b" />
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="state">state</label>
                        <input type="text" required id="state" name="state" style="
                          
                            color: rgb(92, 92, 92) !important;
                          " class="form-control" placeholder="" fdprocessedid="4xtq1b" />
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="pin">Pincode</label>
                        <input type="text" required id="pin" name="pin" style="
                           
                            color: rgb(92, 92, 92) !important;
                          " class="form-control" placeholder="" fdprocessedid="4xtq1b" />
                      </div>
                    </div>

           
    

         

        </div>
        <div class="col-lg-4">
          <div class="order_box">
            <h2>Your Order</h2>
            <ul class="list">
              <li>
                <a href="#"
                  ><h4>Product <span>Total</span></h4></a>
                
              </li>

              <% productData.forEach(function(product) {%> <% var
              a=product.productDetail.price%> <% var b=product.productQuantity%>
              <% var c=a*b %>
              <tr>
            
              </tr>
              

              <li>
                <a href="#"
                  ><%=product.productDetail.name%><span class="middle">x <%=product.productQuantity%></span>
                  <span class="last">₹ <%=c%> </span></a>
                
              </li>
              <% }) %>
             
            </ul>
            <ul class="list list_2">
              <li>
                <a href="#">Subtotal <span> ₹ <%=sum%></span></a>
              </li>
              <li>
                <a href="#">Shipping <span><% if(locals.sum<1000){%>
         
         <h4>₹ 49</h4>
     <%}else{%>
         <h5 class="text-success">Free</h5>
     <%}
      %></span></a>
              </li>
              <li>
                <a href="#">Total <span><% if(locals.sum<1000){%>
         
         <h5>₹ <%=sum+49%></h5>
     <%}else{%>
        <a name="sum" ><h5 > ₹ <%=sum%></h5></a>
     <%}
      %></span></a>
              </li>
              <h2>choose your payment method</h2>
              
            </ul>
            <div class="payment_item">
              <div class="radio">
                        <label><input type="radio" value="COD" name="paymentMethod" class="mr-2" required />
                          COD (cash on delivery)</label>
                      </div>
                      <div class="radio">
                        <label><input type="radio" value="Online" name="paymentMethod" class="mr-2" required />
                          Online</label>
                      </div>
                      <div class="radio">
                        <label><input type="radio" value="Wallet" name="paymentMethod" class="mr-2" required />
                          Wallet</label>
                      </div>
              </div>
              <hr>
            <div class="text-center">
              <button  class="button button-paypal" type="submit" value="submit">
                    Place an Order
                  </button>

            </div>
             
              </div>
              
            </div>
         
          
            <div class="container d-flex">
    <div class="form-group col-md-6">
      <h6>Have a coupon?</h6>
      <div class="input-group">
        <input type="text" class="form-control coupon" id="checkout-form" name="coupon" placeholder="Coupon code" />
        <span class="input-group-append"></span>
      </div>

      <div class="text-center">
                  <button  class="button button-paypal" type="submit"  id="apply-coupon-button" value="submit">
                  apply coupon
           </button>

        </div>

    </div>
  </div>
   
 </form>


        
          
          

          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<!--================End Checkout Area =================-->


<script>
    async function updateAddressDetail(addressId) {
      const res = await fetch("/getAddressDetail/" + addressId);


      const data = await res.json();
      if (data.message === "No addresses") {
        document.querySelector("#phonenumber").value = "";
        document.querySelector("#housename").value = "";
        document.querySelector("#postoffice").value = "";
        document.querySelector("#area").value = "";
        document.querySelector("#district").value = "";
        document.querySelector("#state").value = "";       
        document.querySelector("#pin").value = "";
      } else {
        document.querySelector("#phonenumber").value = data.phonenumber;
        document.querySelector("#housename").value = data.housename;
        document.querySelector("#postoffice").value = data.postoffice;
        document.querySelector("#area").value = data.area;
        document.querySelector("#district").value = data.district;
        document.querySelector("#state").value = data.state;
        document.querySelector("#pin").value = data.pin;
      }
    }
    </script>


    

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>

  function razorpay(order){

    
    var options = {
    "key": 'rzp_test_uOcx6rNQzqB5Di', // Enter the Key ID generated from the Dashboard
    "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
    "currency": "INR",
    "name": "Aroma",
    "description": "Test Transaction",
    "image": "https://example.com/your_logo",
    "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
    "handler": function (response){
        verifyPayment(response,order)
    },
    "prefill": {
        "name": "Aroma",
        "email": "projectshyam3@example.com",
        "contact": "9000090000"
    },
    "notes": {
        "address": "Razorpay Corporate Office"
    },
    "theme": {
        "color": "#3399cc"
    }
};
var rzp1 = new Razorpay(options);
rzp1.on('payment.failed', function (response){

  swal({
        title: "Payment failed!",
        icon: "error",
        confirmButtonText: "continue",
      })
      
});
rzp1.open();
  }


  function verifyPayment(payment, order) {
    console.log("helllo ajax")
    $.ajax({
      

      url: "/verifyPayment",
      data: {
        payment,
        order,
      },
      method: "post",
      success: (response) => {
        if (response.success) {
          location.href ="/orderSuccess";
        }
          
       else{
        
        }
          
        
      },
    });
  }


  




</script>









<%-include('../layouts/footer') %>
